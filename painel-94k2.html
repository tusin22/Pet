<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - PetShop</title>
    <script>
        const password = prompt("Digite a senha de administrador:");
        if (password !== 'admin123') {
            window.location.href = 'index.html';
        }
    </script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --background: #f4f4f9;
            --surface: #ffffff;
            --text: #333333;
            --border: #ddd;
            --danger: #f44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--text);
            margin-bottom: 2rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* Overlap border */
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text);
            background-color: #f0f0f0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Controls Area (Date Picker) */
        .controls {
            background-color: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        @media(min-width: 600px) {
            .controls {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .date-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
        }

        input[type="date"] {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        /* Settings Form */
        .settings-card {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* Modified for Accordion */
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .settings-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: transparent;
            user-select: none;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text);
        }

        .arrow-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .settings-body {
            padding: 0 1.5rem 1.5rem 1.5rem;
            max-height: 2000px; /* Large enough to fit content */
            opacity: 1;
            transition: all 0.5s ease-in-out;
            overflow: hidden;
        }

        /* Collapsed State */
        .settings-card.collapsed .settings-body {
            max-height: 0;
            padding: 0 1.5rem;
            opacity: 0;
        }

        .settings-card.collapsed .arrow-icon {
            transform: rotate(-90deg);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: #f9f9f9;
        }

        .checkbox-item input {
            transform: scale(1.2);
        }

        .btn-save {
            background-color: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-save:hover {
            background-color: #43a047;
        }

        /* Appointments List (Existing Styles) */
        #appointments-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 600px) {
            #appointments-list {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        .card {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .pet-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0;
        }

        .pet-info {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        /* Status Colors */
        .status-agendado { background-color: #e0e0e0; color: #616161; }
        .status-fila { background-color: #ffe0b2; color: #e65100; }
        .status-banho { background-color: #b3e5fc; color: #01579b; }
        .status-secando { background-color: #e1bee7; color: #4a148c; }
        .status-pronto { background-color: #c8e6c9; color: #1b5e20; }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-status {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-status:hover {
            background-color: #f0f0f0;
        }

        .btn-status.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .whatsapp-btn {
            display: block;
            width: 100%;
            text-align: center;
            background-color: #25D366;
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 1rem;
            border: none;
            cursor: pointer;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }

        .delete-btn {
            background-color: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background-color: #ffebee;
        }

        .status-concluido { background-color: #4CAF50; color: white; }
        .status-cancelado { background-color: #9e9e9e; color: white; }

        .btn-concluir {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            font-weight: bold;
        }
        .btn-concluir:hover { background-color: #43A047; }

        .btn-cancelar {
            background-color: transparent;
            color: #f44336;
            border: 1px solid #f44336;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
            font-weight: bold;
        }
        .btn-cancelar:hover { background-color: #ffebee; }

        .btn-reschedule {
            background-color: transparent;
            color: var(--secondary);
            border: 1px solid var(--secondary);
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
            font-weight: bold;
        }
        .btn-reschedule:hover { background-color: #e3f2fd; }

        .reschedule-area {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: #fafafa;
            display: none;
        }

        /* Week Grid Styles */
        .week-grid {
            display: grid;
            grid-template-columns: 60px repeat(6, 1fr); /* Time + 6 Days (Mon-Sat) */
            gap: 1px;
            background-color: var(--border);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            min-width: 800px; /* Ensure horizontal scroll on small screens */
        }

        .week-header, .time-label {
            background-color: white;
            padding: 0.5rem;
            min-height: 60px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .week-cell {
            background-color: white;
            padding: 0;
            min-height: 60px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .week-header {
            background-color: #f0f0f0;
            font-weight: bold;
            color: var(--text);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .time-label {
            font-weight: bold;
            color: #666;
            background-color: #f9f9f9;
        }

        .cell-blocked {
            background-color: #e0e0e0;
            color: #9e9e9e;
            font-size: 0.8rem;
            font-style: italic;
        }

        .cell-booked {
            background-color: #e8f5e9;
            border: none;
            border-left: 4px solid var(--primary);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.25rem;
        }

        .cell-booked:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .cell-booked .pet-mini {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.85rem;
        }

        .cell-booked .owner-mini {
            font-size: 0.75rem;
            color: #555;
        }

        /* Status Modifiers for Week Grid */
        .cell-status-concluido {
            background-color: #f5f5f5;
            border-left-color: #9e9e9e;
            opacity: 0.8;
        }
        .cell-status-concluido .pet-mini { color: #616161; }

        .cell-status-cancelado {
            background-color: #ffebee;
            border-left-color: #f44336;
            opacity: 0.7;
            text-decoration: line-through;
        }
        .cell-status-cancelado .pet-mini { color: #d32f2f; }

        /* Badge Count */
        .count-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #333;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Observations */
        .obs-alert {
            background-color: #fff9c4; /* Light Yellow */
            border-left: 4px solid #fbc02d;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #333;
        }

        .obs-edit-area {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            margin-top: 0.5rem;
        }

        /* Filters */
        .controls-agenda {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .filters-row {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        @media(min-width: 600px) {
            .filters-row {
                flex-direction: row;
                align-items: center;
            }
        }

        .search-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            flex: 2;
        }

        .status-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            flex: 1;
        }

        .time-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            margin-top: 0.25rem;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>Painel Admin üõÅ</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('agenda')">Agenda do Dia</button>
        <button class="tab-btn" onclick="switchTab('semana')">Agenda da Semana</button>
        <button class="tab-btn" onclick="switchTab('historico')">Hist√≥rico</button>
        <button class="tab-btn" onclick="switchTab('config')">Configura√ß√µes</button>
    </div>

    <!-- Agenda Tab -->
    <div id="tab-agenda" class="tab-content active">
        <div class="controls controls-agenda">
            <div class="date-control">
                <label for="agendaDate">Data:</label>
                <input type="date" id="agendaDate">
            </div>

            <div class="filters-row">
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar pet ou telefone...">
                <select id="statusFilter" class="status-select">
                    <option value="Todos">Todos</option>
                    <option value="Agendado">Agendado</option>
                    <option value="Na Fila">Na Fila</option>
                    <option value="No Banho">No Banho</option>
                    <option value="Secando">Secando</option>
                    <option value="Pronto">Pronto</option>
                </select>
            </div>
        </div>

        <div id="appointments-list">
            <p style="text-align: center; color: #666; grid-column: 1/-1;">Selecione uma data para ver os agendamentos.</p>
        </div>
    </div>

    <!-- Semana Tab -->
    <div id="tab-semana" class="tab-content">
        <div class="controls" style="justify-content: center; gap: 1rem; flex-wrap: wrap;">
             <button class="btn-save" style="width: auto; margin:0; padding: 0.5rem 1rem;" onclick="changeWeek(-1)">‚óÄ Semana Anterior</button>
             <span id="week-label" style="font-weight: bold; font-size: 1.1rem; text-align: center;">Semana XX</span>
             <button class="btn-save" style="width: auto; margin:0; padding: 0.5rem 1rem;" onclick="changeWeek(1)">Pr√≥xima Semana ‚ñ∂</button>
        </div>
        <div class="week-grid-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <div id="week-grid" class="week-grid">
                <!-- Grid generated by JS -->
                <p style="grid-column: 1/-1; padding: 2rem; text-align: center;">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- Hist√≥rico Tab -->
    <div id="tab-historico" class="tab-content">
        <div class="controls" style="flex-direction: column; align-items: center; justify-content: center; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <p style="text-align: center; color: #666; margin: 0;">Mostrando os √∫ltimos 50 agendamentos conclu√≠dos ou cancelados.</p>
                <button class="btn-save" style="width: auto; margin: 0; padding: 0.5rem 1rem;" onclick="loadHistory()">Atualizar</button>
            </div>
            <button class="btn-save" style="width: auto; padding: 0.5rem 1rem; background-color: var(--danger);" onclick="deleteAllHistory()">üóëÔ∏è Apagar Todo o Hist√≥rico</button>
        </div>
        <div id="history-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- History items -->
        </div>
    </div>

    <!-- Configura√ß√µes Tab -->
    <div id="tab-config" class="tab-content">
        <!-- Global Settings -->
        <div class="settings-card collapsed" style="margin-bottom: 1.5rem;">
            <div class="settings-header" onclick="toggleCard(this)">
                <h2>Configura√ß√µes Globais</h2>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div class="settings-body">
                <div class="form-group">
                    <label for="globalCapacity" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Capacidade Global de Atendimentos por Hor√°rio:</label>
                    <input type="number" id="globalCapacity" min="1" value="1" style="width: 100%; max-width: 150px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">Define quantos pets podem ser agendados no mesmo hor√°rio.</p>
                    <button class="btn-save" style="margin-top: 0.5rem; width: auto;" onclick="saveGlobalSettings()">Salvar Capacidade Global</button>
                </div>
            </div>
        </div>

        <!-- Tempos e Dura√ß√£o -->
        <div class="settings-card collapsed" style="margin-bottom: 1.5rem;">
            <div class="settings-header" onclick="toggleCard(this)">
                <h2>Tempos e Dura√ß√£o</h2>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div class="settings-body">
                <div class="form-group">
                    <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Intervalo da Agenda (minutos):</label>
                    <input type="number" id="agendaInterval" min="10" value="30" step="5" style="width: 100%; max-width: 150px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem;">
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <h3 style="font-size: 1rem; color: #666;">Dura√ß√£o por Servi√ßo (min)</h3>
                        <div class="form-group">
                            <label>Banho</label>
                            <input type="number" id="timeBanho" class="time-input" value="30">
                        </div>
                        <div class="form-group">
                            <label>Tosa</label>
                            <input type="number" id="timeTosa" class="time-input" value="45">
                        </div>
                        <div class="form-group">
                            <label>Banho e Tosa</label>
                            <input type="number" id="timeBanhoTosa" class="time-input" value="90">
                        </div>
                         <div class="form-group">
                            <label>Outros</label>
                            <input type="number" id="timeOutros" class="time-input" value="30">
                        </div>
                    </div>

                    <div>
                        <h3 style="font-size: 1rem; color: #666;">Tempo Extra por Porte (min)</h3>
                        <div class="form-group">
                            <label>Pequeno (P)</label>
                            <input type="number" id="extraP" class="time-input" value="0">
                        </div>
                        <div class="form-group">
                            <label>M√©dio (M)</label>
                            <input type="number" id="extraM" class="time-input" value="15">
                        </div>
                        <div class="form-group">
                            <label>Grande (G)</label>
                            <input type="number" id="extraG" class="time-input" value="30">
                        </div>
                    </div>
                </div>

                <button class="btn-save" onclick="saveTimeSettings()">Salvar Configura√ß√µes de Tempo</button>
            </div>
        </div>

        <div class="settings-card collapsed">
            <div class="settings-header" onclick="toggleCard(this)">
                <h2>Gerenciar Disponibilidade (Por Dia)</h2>
                <span class="arrow-icon">‚ñº</span>
            </div>
            <div class="settings-body">
                <div class="form-group">
                    <label for="configDate">Selecione a Data:</label>
                    <input type="date" id="configDate" style="width: 100%; max-width: 300px; margin-top: 0.5rem;">
                </div>

                <div id="config-options" style="display: none;">
                    <div class="form-group">
                        <label class="checkbox-item" style="border: none; padding: 0;">
                            <input type="checkbox" id="blockAllDay">
                            <span style="font-size: 1.1rem; font-weight: bold;">Bloquear Dia Inteiro (Fechado)</span>
                        </label>
                    </div>

                    <div class="form-group" id="slots-group">
                        <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Bloquear Hor√°rios Espec√≠ficos:</label>
                        <div class="checkbox-group" id="slots-checkboxes">
                            <!-- Checkboxes generated by JS -->
                        </div>
                    </div>

                    <button class="btn-save" onclick="saveConfiguration()">Salvar Configura√ß√µes</button>
                </div>
                 <p id="config-message" style="text-align: center; color: #666; margin-top: 1rem; display: none;"></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="appointment-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal(null, true)">√ó</button>
        <div id="modal-body">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy, where, limit, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAKWE3DBMGVP1AgUN9oajztpteVzmMi92s",
        authDomain: "sistema-petshop-33f9d.firebaseapp.com",
        projectId: "sistema-petshop-33f9d",
        storageBucket: "sistema-petshop-33f9d.firebasestorage.app",
        messagingSenderId: "628550103939",
        appId: "1:628550103939:web:4a862eee914840d238fcb6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- State & Elements ---
    const agendaDateInput = document.getElementById('agendaDate');
    const listContainer = document.getElementById('appointments-list');
    const historyContainer = document.getElementById('history-list');

    const configDateInput = document.getElementById('configDate');
    const configOptions = document.getElementById('config-options');
    const blockAllDayCheckbox = document.getElementById('blockAllDay');
    const slotsCheckboxesContainer = document.getElementById('slots-checkboxes');
    const configMessage = document.getElementById('config-message');
    const globalCapacityInput = document.getElementById('globalCapacity');

    // Week Grid Elements
    const weekGrid = document.getElementById('week-grid');
    const weekLabel = document.getElementById('week-label');

    let unsubscribe = null; // Store listener for Agenda
    let historyUnsubscribe = null; // Store listener for History
    let weekUnsubscribe = null; // Store listener for Week

    // Week State
    let currentWeekStart = new Date();
    // Adjust to Monday of current week
    const day = currentWeekStart.getDay();
    const diff = currentWeekStart.getDate() - day + (day === 0 ? -6 : 1); // If sunday (-6), else (day-1)
    currentWeekStart.setDate(diff);
    currentWeekStart.setHours(0,0,0,0);

    // Time slots definition (08:00 to 17:00)
    const timeSlots = [
        "08:00", "09:00", "10:00", "11:00", "12:00",
        "13:00", "14:00", "15:00", "16:00", "17:00"
    ];

    // --- Initialization ---
    // Set default date to today for both inputs
    const today = toLocalDateString(new Date());
    agendaDateInput.value = today;
    configDateInput.value = today;

    // --- Functions ---

    function toLocalDateString(date) {
        const pad = (n) => n < 10 ? '0' + n : n;
        return date.getFullYear() + '-' +
            pad(date.getMonth() + 1) + '-' +
            pad(date.getDate());
    }

    function toLocalISOString(date) {
        const pad = (n) => n < 10 ? '0' + n : n;
        return date.getFullYear() + '-' +
            pad(date.getMonth() + 1) + '-' +
            pad(date.getDate()) + 'T' +
            pad(date.getHours()) + ':' +
            pad(date.getMinutes());
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    window.toggleCard = (header) => {
        const card = header.parentElement;
        card.classList.toggle('collapsed');
    };

    window.switchTab = (tabName) => {
        // Hide all contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

        // Show selected
        document.getElementById(`tab-${tabName}`).classList.add('active');

        // Update button state
        const buttons = document.querySelectorAll('.tab-btn');
        // 0: Agenda, 1: Week, 2: History, 3: Config
        if (tabName === 'agenda') {
            buttons[0].classList.add('active');
            if (historyUnsubscribe) { historyUnsubscribe(); historyUnsubscribe = null; }
            if (weekUnsubscribe) { weekUnsubscribe(); weekUnsubscribe = null; }
            loadAppointments();
        }
        else if (tabName === 'semana') {
            buttons[1].classList.add('active');
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            if (historyUnsubscribe) { historyUnsubscribe(); historyUnsubscribe = null; }
            loadWeekSchedule();
        }
        else if (tabName === 'historico') {
            buttons[2].classList.add('active');
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            if (weekUnsubscribe) { weekUnsubscribe(); weekUnsubscribe = null; }
            loadHistory();
        }
        else if (tabName === 'config') {
            buttons[3].classList.add('active');
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            if (historyUnsubscribe) { historyUnsubscribe(); historyUnsubscribe = null; }
            if (weekUnsubscribe) { weekUnsubscribe(); weekUnsubscribe = null; }
            loadConfiguration();
        }
    };

    window.loadAppointments = () => {
        const dateVal = agendaDateInput.value;
        if (!dateVal) return;

        // Unsubscribe previous listener if exists
        if (unsubscribe) {
            unsubscribe();
        }

        listContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Carregando agendamentos...</p>';

        // Query Range for the entire day
        const startOfDay = `${dateVal}T00:00`;
        const endOfDay = `${dateVal}T23:59`;

        const q = query(
            collection(db, "appointments"),
            where("appointmentTime", ">=", startOfDay),
            where("appointmentTime", "<=", endOfDay),
            orderBy("appointmentTime", "asc")
        );

        unsubscribe = onSnapshot(q, (snapshot) => {
            listContainer.innerHTML = ''; // Clear list

            const activeDocs = [];
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const s = (data.status || '').toLowerCase();
                // Filter out finished/cancelled
                if (s !== 'conclu√≠do' && s !== 'cancelado') {
                    activeDocs.push({id: docSnap.id, ...data});
                }
            });

            if (activeDocs.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Nenhum agendamento ativo para este dia.</p>';
                return;
            }

            activeDocs.forEach((item) => {
                listContainer.appendChild(createCard(item.id, item, false));
            });
            // Re-apply filters after loading
            filterAppointments();
        }, (error) => {
            console.error("Error fetching appointments:", error);
            listContainer.innerHTML = '<p style="text-align: center; color: red; grid-column: 1/-1;">Erro ao carregar agendamentos.</p>';
        });
    };

    window.filterAppointments = () => {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        if (!searchInput || !statusFilter) return;

        const filterText = searchInput.value.toLowerCase();
        const filterPhone = filterText.replace(/\D/g, ''); // Extract digits
        const filterStatus = statusFilter.value;

        const cards = document.querySelectorAll('#appointments-list .card');

        cards.forEach(card => {
            const petName = (card.getAttribute('data-pet-name') || '').toLowerCase();
            const ownerPhone = (card.getAttribute('data-owner-phone') || '');
            const status = card.getAttribute('data-status') || '';

            let show = true;

            // Status Filter
            if (filterStatus !== 'Todos' && status !== filterStatus) {
                show = false;
            }

            // Search Filter
            if (show && filterText.trim() !== '') {
                const nameMatch = petName.includes(filterText);
                let phoneMatch = false;
                if (filterPhone.length > 0) {
                    phoneMatch = ownerPhone.includes(filterPhone);
                }

                if (!nameMatch && !phoneMatch) {
                    show = false;
                }
            }

            card.style.display = show ? 'flex' : 'none';
        });
    };

    window.loadHistory = () => {
        if (historyUnsubscribe) {
            historyUnsubscribe();
        }

        // Load last 50 appointments
        historyContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Carregando hist√≥rico...</p>';

        const q = query(
            collection(db, "appointments"),
            orderBy("appointmentTime", "desc"),
            limit(100) // Fetch more to filter client side if needed
        );

        historyUnsubscribe = onSnapshot(q, (snapshot) => {
            historyContainer.innerHTML = '';

            const historyDocs = [];
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const s = (data.status || '').toLowerCase();
                if (s === 'conclu√≠do' || s === 'cancelado') {
                    historyDocs.push({id: docSnap.id, ...data});
                }
            });

            if (historyDocs.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Nenhum hist√≥rico recente encontrado.</p>';
                return;
            }

            // Limit display to 50
            historyDocs.slice(0, 50).forEach((item) => {
                historyContainer.appendChild(createCard(item.id, item, true));
            });
        });
    };

    // --- Week Logic ---

    window.changeWeek = (direction) => {
        // direction: -1 or 1
        currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
        loadWeekSchedule();
    };

    window.loadWeekSchedule = async () => {
        if (weekUnsubscribe) {
            weekUnsubscribe();
        }

        // Calculate Range
        const startOfWeek = new Date(currentWeekStart);
        const endOfWeek = new Date(currentWeekStart);
        endOfWeek.setDate(endOfWeek.getDate() + 6); // Sunday (which we ignore in grid but fetch for range safety)
        endOfWeek.setHours(23, 59, 59, 999);

        // Update Label
        const startStr = startOfWeek.toLocaleDateString('pt-BR', {day: 'numeric', month: 'numeric'});
        const endStr = endOfWeek.toLocaleDateString('pt-BR', {day: 'numeric', month: 'numeric'});
        // Get week number (rough estimate)
        const oneJan = new Date(startOfWeek.getFullYear(), 0, 1);
        const numberOfDays = Math.floor((startOfWeek - oneJan) / (24 * 60 * 60 * 1000));
        const weekNum = Math.ceil((startOfWeek.getDay() + 1 + numberOfDays) / 7);

        weekLabel.textContent = `Semana ${weekNum} (${startStr} a ${endStr})`;

        weekGrid.innerHTML = '<p style="grid-column: 1/-1; padding: 2rem; text-align: center;">Carregando...</p>';

        // 1. Fetch Configs for the week
        // We need configs for Mon-Sat. Firestore doesn't support "IN" with dates easily if ID is date
        // So we'll just fetch them in parallel.
        const weekDates = [];
        for (let i = 0; i < 6; i++) { // 0=Mon, 5=Sat
            const d = new Date(startOfWeek);
            d.setDate(d.getDate() + i);
            weekDates.push(toLocalDateString(d));
        }

        const configs = {};
        try {
            const configPromises = weekDates.map(dateStr => getDoc(doc(db, "configuracoes", dateStr)));
            const configSnaps = await Promise.all(configPromises);
            configSnaps.forEach((snap, idx) => {
                if (snap.exists()) {
                    configs[weekDates[idx]] = snap.data();
                }
            });
        } catch (e) {
            console.error("Error loading configs:", e);
        }

        // 2. Fetch Appointments
        const rangeStart = toLocalISOString(startOfWeek);
        const rangeEnd = toLocalISOString(endOfWeek);

        const q = query(
            collection(db, "appointments"),
            where("appointmentTime", ">=", rangeStart),
            where("appointmentTime", "<=", rangeEnd)
        );

        weekUnsubscribe = onSnapshot(q, (snapshot) => {
            const appointments = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                appointments.push({id: doc.id, ...data});
            });

            renderWeekGrid(weekDates, configs, appointments);
        });
    };

    function renderWeekGrid(weekDates, configs, appointments) {
        weekGrid.innerHTML = '';

        // Header Row
        // Empty top-left
        const emptyHeader = document.createElement('div');
        emptyHeader.className = 'week-header';
        weekGrid.appendChild(emptyHeader);

        const daysOfWeek = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

        weekDates.forEach((dateStr, idx) => {
            const [y, m, d] = dateStr.split('-');
            const header = document.createElement('div');
            header.className = 'week-header';
            header.innerHTML = `${daysOfWeek[idx]}<br><span style="font-weight:normal">${d}/${m}</span>`;
            weekGrid.appendChild(header);
        });

        // Time Rows
        timeSlots.forEach(time => {
            // Time Label
            const label = document.createElement('div');
            label.className = 'time-label';
            label.textContent = time;
            weekGrid.appendChild(label);

            // Cells for each day
            weekDates.forEach(dateStr => {
                const cell = document.createElement('div');
                cell.className = 'week-cell';

                const fullIso = `${dateStr}T${time}`;

                // Check Blocking
                let isBlocked = false;
                if (configs[dateStr]) {
                    if (configs[dateStr].blockedAllDay) isBlocked = true;
                    if (configs[dateStr].blockedSlots && configs[dateStr].blockedSlots.includes(time)) isBlocked = true;
                }

                if (isBlocked) {
                    cell.classList.add('cell-blocked');
                    cell.textContent = 'Bloqueado';
                } else {
                    // Check Appointments (Find all for this slot)
                    const apps = appointments.filter(a => a.appointmentTime === fullIso);

                    if (apps.length > 0) {
                        const firstApp = apps[0];
                        cell.classList.add('cell-booked');

                        // Status Class logic (based on first item)
                        const s = (firstApp.status || '').toLowerCase();
                        if (s.includes('conclu√≠do')) cell.classList.add('cell-status-concluido');
                        else if (s.includes('cancelado')) cell.classList.add('cell-status-cancelado');

                        // Icon mapping
                        let icon = 'üìÖ';
                        if (s.includes('banho')) icon = 'üöø';
                        else if (s.includes('secando')) icon = 'üí®';
                        else if (s.includes('pronto')) icon = '‚úÖ';
                        else if (s.includes('fila')) icon = '‚è≥';
                        else if (s.includes('cancelado')) icon = '‚ùå';
                        else if (s.includes('conclu√≠do')) icon = 'üèÅ';

                        // Badge logic
                        let badgeHtml = '';
                        if (apps.length > 1) {
                            badgeHtml = `<div class="count-badge">+${apps.length - 1}</div>`;
                        }

                        cell.innerHTML = `
                            ${badgeHtml}
                            <div class="pet-mini">${icon} ${escapeHtml(firstApp.petName)}</div>
                            <div class="owner-mini">${escapeHtml(firstApp.ownerName || '')}</div>
                        `;

                        // Pass full array to modal
                        cell.onclick = () => openModal(apps);
                    }
                }
                weekGrid.appendChild(cell);
            });
        });
    }

    // --- Modal Logic ---
    window.openModal = (appts) => {
        const modal = document.getElementById('appointment-modal');
        const modalBody = document.getElementById('modal-body');

        modalBody.innerHTML = '';

        const list = Array.isArray(appts) ? appts : [appts];

        list.forEach(appt => {
            const card = createCard(appt.id, appt, false);
            // Tweak card styles for modal if necessary
            card.style.boxShadow = 'none';
            card.style.border = '1px solid #eee';
            card.style.marginBottom = '1rem';

            modalBody.appendChild(card);
        });

        modal.classList.add('active');
    };

    window.closeModal = (event, force) => {
        if (force || event.target.classList.contains('modal-overlay')) {
            document.getElementById('appointment-modal').classList.remove('active');
        }
    };

    function createCard(id, data, isHistory) {
        const card = document.createElement('div');
        card.className = 'card';

        // Data Attributes for Filtering
        card.setAttribute('data-pet-name', (data.petName || '').toLowerCase());
        card.setAttribute('data-owner-phone', (data.ownerPhone || '').replace(/\D/g, ''));
        card.setAttribute('data-status', data.status || '');

        // Determine status class
        let statusClass = 'status-fila';
        const s = (data.status || '').toLowerCase();
        if (s.includes('agendado')) statusClass = 'status-agendado';
        else if (s.includes('banho')) statusClass = 'status-banho';
        else if (s.includes('secando')) statusClass = 'status-secando';
        else if (s.includes('pronto')) statusClass = 'status-pronto';
        else if (s.includes('conclu√≠do')) statusClass = 'status-concluido';
        else if (s.includes('cancelado')) statusClass = 'status-cancelado';

        // Format Date
        const dateObj = new Date(data.appointmentTime);
        const dateStr = dateObj.toLocaleDateString('pt-BR');
        const timeStr = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

        // Owner Name Display
        const ownerName = data.ownerName ? ` (${data.ownerName})` : '';

        // Extra Fields
        const serviceType = data.serviceType || 'N√£o informado';
        const petSize = data.petSize || 'N√£o informado';
        const paymentMethod = data.paymentMethod || 'N√£o informado';

        // Observations Section
        let obsHtml = '';
        if (data.observations) {
             obsHtml = `
                <div class="obs-alert">
                    <strong>‚ö†Ô∏è Observa√ß√µes:</strong>
                    <div style="white-space: pre-wrap;">${escapeHtml(data.observations)}</div>
                </div>
             `;
        }

        // Edit Obs Section
        const editObsHtml = `
            <details style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                <summary style="cursor: pointer; color: var(--secondary); font-size: 0.9rem;">üìù Editar Observa√ß√µes</summary>
                <textarea id="obs-input-${id}" class="obs-edit-area" rows="3" placeholder="Escreva aqui...">${escapeHtml(data.observations || '')}</textarea>
                <button class="btn-save" style="margin-top: 0.5rem; padding: 0.5rem;" onclick="saveObservation('${id}')">Salvar Observa√ß√£o</button>
            </details>
        `;

        // WhatsApp Button Logic
        let whatsappHtml = '';
        if (s.includes('pronto') && data.ownerPhone && !isHistory) {
            let phone = data.ownerPhone;
            if (phone.length <= 11) {
                phone = '55' + phone;
            }
            // Use escaped pet name for message if desired, but URL encoding handles safety there.
            const message = encodeURIComponent(`Ol√°! O banho do(a) ${data.petName} foi finalizado e ele(a) j√° est√° pronto(a) para ser buscado(a)! üê∂‚ú®`);
            const link = `https://api.whatsapp.com/send?phone=${phone}&text=${message}`;
            whatsappHtml = `<a href="${link}" target="_blank" class="whatsapp-btn">üì± Avisar Dono (WhatsApp)</a>`;
        }

        let buttonsHtml = '';
        if (!isHistory) {
            const currentIsoDate = data.appointmentTime.split('T')[0];
            const currentTime = data.appointmentTime.split('T')[1];

            const options = timeSlots.map(t => `<option value="${t}" ${t === currentTime ? 'selected' : ''}>${t}</option>`).join('');

            buttonsHtml = `
            <div class="actions">
                <button class="btn-status ${data.status === 'Agendado' ? 'active' : ''}" onclick="updateStatus('${id}', 'Agendado')">Agendado</button>
                <button class="btn-status ${data.status === 'Na Fila' ? 'active' : ''}" onclick="updateStatus('${id}', 'Na Fila')">Fila</button>
                <button class="btn-status ${data.status === 'No Banho' ? 'active' : ''}" onclick="updateStatus('${id}', 'No Banho')">Banho</button>
                <button class="btn-status ${data.status === 'Secando' ? 'active' : ''}" onclick="updateStatus('${id}', 'Secando')">Secando</button>
                <button class="btn-status ${data.status === 'Pronto' ? 'active' : ''}" onclick="updateStatus('${id}', 'Pronto')">Pronto</button>
            </div>

            ${whatsappHtml}

            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-cancelar" onclick="cancelAppointment('${id}')">‚ùå Cancelar</button>
                <button class="btn-reschedule" onclick="toggleReschedule('${id}')">üóìÔ∏è Remarcar</button>
            </div>

            <div id="reschedule-area-${id}" class="reschedule-area">
                <label style="display:block; margin-bottom:0.5rem; font-weight:bold;">Nova Data:</label>
                <input type="date" id="reschedule-date-${id}" value="${currentIsoDate}" style="width:100%; padding:0.5rem; margin-bottom:1rem; border:1px solid #ddd; border-radius:6px;">

                <label style="display:block; margin-bottom:0.5rem; font-weight:bold;">Novo Hor√°rio:</label>
                <select id="reschedule-time-${id}" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:6px; margin-bottom:1rem;">
                    ${options}
                </select>

                <button class="btn-save" style="margin-top:0;" onclick="saveReschedule('${id}')">Salvar Novo Hor√°rio</button>
            </div>

            <button class="btn-concluir" onclick="confirmAndComplete('${id}')">‚úÖ Concluir</button>
            `;
        } else {
            buttonsHtml = `
            <button class="delete-btn" onclick="deletePermanently('${id}')">üóëÔ∏è Apagar permanentemente</button>
            `;
        }

        card.innerHTML = `
            <div class="card-header">
                <span class="status-badge ${statusClass}">${data.status}</span>
                <h3 class="pet-name">${escapeHtml(data.petName)}${escapeHtml(ownerName)}</h3>
                <div class="pet-info" style="margin-top: 0.5rem; color: #333;">
                     <strong>Servi√ßo:</strong> ${escapeHtml(serviceType)} | <strong>Porte:</strong> ${escapeHtml(petSize)}
                </div>
                <div class="pet-info" style="color: #333;">
                     <strong>Pagamento:</strong> ${escapeHtml(paymentMethod)}
                </div>
                <div class="pet-info" style="margin-top: 0.5rem;">üìÖ ${dateStr} - üïí ${timeStr}</div>
                <div class="pet-info">üìû ${formatPhone(data.ownerPhone)}</div>
            </div>
            ${obsHtml}
            ${editObsHtml}
            ${buttonsHtml}
        `;

        return card;
    }

    function formatPhone(phone) {
        if (!phone) return '';
        if (phone.length === 11) {
            return `(${phone.substring(0,2)}) ${phone.substring(2,7)}-${phone.substring(7)}`;
        }
        return phone;
    }

    // --- Settings Logic ---

    // Generate Checkboxes once
    function generateSlotCheckboxes() {
        slotsCheckboxesContainer.innerHTML = '';
        timeSlots.forEach(slot => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `
                <input type="checkbox" name="blockedSlot" value="${slot}">
                <span>${slot}</span>
            `;
            slotsCheckboxesContainer.appendChild(label);
        });
    }

    window.loadConfiguration = async () => {
        const dateVal = configDateInput.value;
        if (!dateVal) {
            configOptions.style.display = 'none';
            return;
        }

        const dateObj = new Date(dateVal + 'T00:00:00');
        if (dateObj.getDay() === 0) {
            configOptions.style.display = 'none';
            configMessage.textContent = "Domingos s√£o fechados por padr√£o e n√£o podem ser modificados.";
            configMessage.style.display = 'block';
            configMessage.style.color = '#d32f2f'; // Red color for emphasis
            return;
        }

        configOptions.style.display = 'block';
        configMessage.style.display = 'none';
        configMessage.style.color = '#666'; // Reset color

        // Reset form
        blockAllDayCheckbox.checked = false;
        document.querySelectorAll('input[name="blockedSlot"]').forEach(cb => cb.checked = false);

        try {
            const docRef = doc(db, "configuracoes", dateVal);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.blockedAllDay) {
                    blockAllDayCheckbox.checked = true;
                }
                if (data.blockedSlots && Array.isArray(data.blockedSlots)) {
                    data.blockedSlots.forEach(slot => {
                        const cb = document.querySelector(`input[name="blockedSlot"][value="${slot}"]`);
                        if (cb) cb.checked = true;
                    });
                }
            }
        } catch (error) {
            console.error("Error loading config:", error);
            alert("Erro ao carregar configura√ß√µes.");
        }
    };

    window.saveConfiguration = async () => {
        const dateVal = configDateInput.value;
        if (!dateVal) return;

        const dateObj = new Date(dateVal + 'T00:00:00');
        if (dateObj.getDay() === 0) {
            alert("N√£o √© poss√≠vel alterar configura√ß√µes de domingos.");
            return;
        }

        const blockedAllDay = blockAllDayCheckbox.checked;
        const blockedSlots = [];
        document.querySelectorAll('input[name="blockedSlot"]:checked').forEach(cb => {
            blockedSlots.push(cb.value);
        });

        const data = {
            blockedAllDay: blockedAllDay,
            blockedSlots: blockedSlots
        };

        try {
            await setDoc(doc(db, "configuracoes", dateVal), data);
            configMessage.textContent = "Configura√ß√µes salvas com sucesso! ‚úÖ";
            configMessage.style.display = 'block';
            setTimeout(() => {
                configMessage.style.display = 'none';
            }, 3000);
        } catch (error) {
            console.error("Error saving config:", error);
            alert("Erro ao salvar configura√ß√µes.");
        }
    };

    // --- Global Actions (Status Update / Delete) ---
    window.saveObservation = async (id) => {
        const input = document.getElementById(`obs-input-${id}`);
        const newText = input.value.trim();

        try {
             await updateDoc(doc(db, "appointments", id), {
                observations: newText
            });
            alert("Observa√ß√£o salva com sucesso!");
        } catch(e) {
            console.error("Error saving obs:", e);
            alert("Erro ao salvar observa√ß√£o.");
        }
    };

    window.updateStatus = async (id, newStatus) => {
        try {
            const docRef = doc(db, "appointments", id);
            await updateDoc(docRef, {
                status: newStatus
            });
        } catch (e) {
            console.error("Error updating status: ", e);
            alert("Erro ao atualizar status.");
        }
    };

    window.cancelAppointment = async (id) => {
        if (confirm("Tem certeza que deseja CANCELAR este agendamento?")) {
            try {
                await updateStatus(id, 'Cancelado');
            } catch (e) {
                console.error("Error canceling document: ", e);
                alert("Erro ao cancelar.");
            }
        }
    };

    window.confirmAndComplete = async (id) => {
        if (confirm("Tem certeza que deseja CONCLUIR este agendamento?")) {
            await updateStatus(id, 'Conclu√≠do');
        }
    };

    window.deletePermanently = async (id) => {
        if (confirm("Tem certeza que deseja APAGAR este agendamento permanentemente?")) {
            try {
                await deleteDoc(doc(db, "appointments", id));
                // If we are in history tab, the listener will update the list
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("Erro ao apagar agendamento.");
            }
        }
    };

    window.deleteAllHistory = async () => {
        if (!confirm("ESTA A√á√ÉO √â IRREVERS√çVEL. Deseja apagar todo o hist√≥rico?")) {
            return;
        }

        const sure = prompt("Para confirmar, digite 'APAGAR' (sem aspas):");
        if (sure !== 'APAGAR') {
            alert("A√ß√£o cancelada.");
            return;
        }

        try {
            // Get all Completed or Cancelled appointments
            // Note: Firestore 'in' query supports up to 10 values
            const q = query(
                collection(db, "appointments"),
                where("status", "in", ["Conclu√≠do", "Cancelado"])
            );

            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                alert("Nenhum hist√≥rico para apagar.");
                return;
            }

            const batch = writeBatch(db);
            snapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            alert("Hist√≥rico apagado com sucesso!");
        } catch (e) {
            console.error("Error deleting history: ", e);
            alert("Erro ao apagar hist√≥rico.");
        }
    };

    window.toggleReschedule = (id) => {
        const area = document.getElementById(`reschedule-area-${id}`);
        if (area.style.display === 'block') {
            area.style.display = 'none';
        } else {
            area.style.display = 'block';
        }
    };

    window.saveReschedule = async (id) => {
        const dateInput = document.getElementById(`reschedule-date-${id}`);
        const timeInput = document.getElementById(`reschedule-time-${id}`);

        const newDate = dateInput.value;
        const newTime = timeInput.value;

        if (!newDate || !newTime) {
            alert("Selecione data e hor√°rio.");
            return;
        }

        // Sunday Check
        const dateObj = new Date(newDate + 'T00:00:00');
        if (dateObj.getDay() === 0) {
            alert("N√£o √© poss√≠vel agendar ou remarcar para Domingos.");
            return;
        }

        const newAppointmentTime = `${newDate}T${newTime}`;

        // Conflict Check
        try {
            const q = query(
                collection(db, "appointments"),
                where("appointmentTime", "==", newAppointmentTime)
            );

            const snapshot = await getDocs(q);
            let activeCount = 0;

            snapshot.forEach(doc => {
                // Count active appointments at this time, excluding the one we are editing
                // Note: Ignoring self (doc.id !== id) ensures we can save changes even if slot is full (by us)
                if (doc.id !== id && doc.data().status !== 'Cancelado' && doc.data().status !== 'Conclu√≠do') {
                    activeCount++;
                }
            });

            // Get Global Capacity
            let capacity = 1;
            const capInput = document.getElementById('globalCapacity');
            if (capInput && capInput.value) {
                capacity = parseInt(capInput.value);
            }

            if (activeCount >= capacity) {
                if (!confirm(`Este hor√°rio j√° atingiu a capacidade m√°xima (${capacity}). Deseja fazer um encaixe mesmo assim?`)) {
                    return; // Cancel action
                }
            }

            // Update
            await updateDoc(doc(db, "appointments", id), {
                appointmentTime: newAppointmentTime,
                status: 'Agendado'
            });

            alert("Agendamento remarcado com sucesso!");
            // Hide area
            toggleReschedule(id);
            // The onSnapshot listener will update the UI automatically.

        } catch(e) {
            console.error("Error rescheduling:", e);
            alert("Erro ao remarcar agendamento.");
        }
    };

    // --- Event Listeners ---

    // Agenda Tab
    agendaDateInput.addEventListener('change', () => {
        loadAppointments();
    });
    agendaDateInput.addEventListener('input', () => {
        loadAppointments();
    });

    // Filters
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');

    if (searchInput) {
        searchInput.addEventListener('input', filterAppointments);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterAppointments);
    }

    // Configura√ß√µes Tab
    configDateInput.addEventListener('change', () => {
        loadConfiguration();
    });
    configDateInput.addEventListener('input', () => {
        loadConfiguration();
    });

    // --- Execution ---
    generateSlotCheckboxes();
    loadAppointments();
    loadGlobalSettings();
    loadTimeSettings();

    // --- Global Settings Logic ---
    async function loadGlobalSettings() {
        try {
            const docRef = doc(db, "configuracoes", "geral");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.capacityPerSlot) {
                    globalCapacityInput.value = data.capacityPerSlot;
                }
            }
        } catch (e) {
            console.error("Error loading global settings:", e);
        }
    }

    window.saveGlobalSettings = async () => {
        const val = parseInt(globalCapacityInput.value);
        if (val < 1) {
            alert("A capacidade deve ser pelo menos 1.");
            return;
        }

        try {
            const docRef = doc(db, "configuracoes", "geral");
            await setDoc(docRef, { capacityPerSlot: val }, { merge: true });
            alert("Capacidade global salva com sucesso!");
        } catch (e) {
            console.error("Error saving global settings:", e);
            alert("Erro ao salvar configura√ß√£o global.");
        }
    };

    // --- Time & Duration Settings Logic ---
    async function loadTimeSettings() {
        try {
            const docRef = doc(db, "configuracoes", "tempos");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.agendaInterval) document.getElementById('agendaInterval').value = data.agendaInterval;

                if (data.services) {
                    if (data.services['Banho']) document.getElementById('timeBanho').value = data.services['Banho'];
                    if (data.services['Tosa']) document.getElementById('timeTosa').value = data.services['Tosa'];
                    if (data.services['Banho e Tosa']) document.getElementById('timeBanhoTosa').value = data.services['Banho e Tosa'];
                    if (data.services['Outros']) document.getElementById('timeOutros').value = data.services['Outros'];
                }

                if (data.sizes) {
                    if (data.sizes['P']) document.getElementById('extraP').value = data.sizes['P'];
                    if (data.sizes['M']) document.getElementById('extraM').value = data.sizes['M'];
                    if (data.sizes['G']) document.getElementById('extraG').value = data.sizes['G'];
                }
            }
        } catch (e) {
            console.error("Error loading time settings:", e);
        }
    }

    window.saveTimeSettings = async () => {
        const agendaInterval = parseInt(document.getElementById('agendaInterval').value) || 30;

        const services = {
            'Banho': parseInt(document.getElementById('timeBanho').value) || 30,
            'Tosa': parseInt(document.getElementById('timeTosa').value) || 45,
            'Banho e Tosa': parseInt(document.getElementById('timeBanhoTosa').value) || 90,
            'Outros': parseInt(document.getElementById('timeOutros').value) || 30
        };

        const sizes = {
            'P': parseInt(document.getElementById('extraP').value) || 0,
            'M': parseInt(document.getElementById('extraM').value) || 15,
            'G': parseInt(document.getElementById('extraG').value) || 30
        };

        try {
            await setDoc(doc(db, "configuracoes", "tempos"), {
                agendaInterval: agendaInterval,
                services: services,
                sizes: sizes
            });
            alert("Configura√ß√µes de tempo salvas com sucesso!");
        } catch (e) {
            console.error("Error saving time settings:", e);
            alert("Erro ao salvar configura√ß√µes de tempo.");
        }
    };

</script>

</body>
</html>
